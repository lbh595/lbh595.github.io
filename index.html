<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        div {
            margin: 0;
            padding: 0;
            border: 0;
        }

        body {
            margin-top: 10px;
        }

        svg {
            background: #fff;
            vertical-align: top;
        }
    </style>
    <title>ECG</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

</head>

<body>
    <input type="file" name="file" id="file">

    <script type="text/javascript">

        //configuration
        let magnification = 4;
        let orientation = -1;

        //
        let px2mm = 3.7795275590551;
        let baseLineOffset = px2mm * 5 * 3.5;

        // 0.04s 最小的格子(pixel)
        let unit = px2mm;
        // 0.04s 最小的格子要幾格產生一個0.2s的中格子(Block)
        let smallGridBlocks = 5;
        // 0.2s 的格子水平要多少個
        let gridXBlocks = 5;
        // 0.2s 的格子垂直要多少個
        let gridYBlocks = 5;

        // 由 gridXBlocks 及 gridYBlocks 產生一個單位的 largeGrid(1s)

        let largeGridXBlocks = 5;

        let largeGridYBlocks = 5;

        // 1s 的格子水平要多少個
        let horizontalBlocks = 10;
        // 1s 的格子垂直要多少個
        let verticalBlocks = 1;

        // offsetPixel : 邊界的誤差，因為 stroke-width 的關係
        let offsetPixel = 1.5;
        // 
        let textWidth = 17;
        let textHeight = 17;

        var ecgGridWidth = horizontalBlocks * unit * smallGridBlocks * gridXBlocks + offsetPixel;
        var ecgGridHeight = verticalBlocks * unit * smallGridBlocks * gridYBlocks + offsetPixel;
        $(function () {
            document.getElementById('file').onchange = function () {

                var file = this.files[0];
                var data = [];
                var lineData = [];
                var reader = new FileReader();

                reader.onload = function (progressEvent) {
                    // Entire file
                    //console.log(this.result);
                    // By lines
                    var lines = this.result.split('\n');
                    for (var line = 0; line < lines.length; line++) {
                        data.push(lines[line]);
                    }

                    var temp = [];

                    //first 5 zeros
                    for (i = 1; i <= 5; i++) {
                        temp.push({ "x": i * unit * 0.1, "y": 0 + baseLineOffset });
                    }

                    for (i = 5; i < data.length; i++) {
                        if (temp.length < 2500) {

                            temp.push({ "x": temp.length * unit * 0.1, "y": data[i] * orientation * magnification + baseLineOffset });
                            console.log(temp.length);
                        }
                        else {
                            lineData.push(temp);
                            var temp = [];
                            temp.push({ "x": temp.length * unit * 0.1, "y": data[i] * orientation * magnification + baseLineOffset });
                            console.log(temp.length);
                        }

                    }
                    console.log("length" + data.length);

                    //This is the accessor function
                    var lineFunction = d3.svg.line()
                        .x(function (d) { return d.x; })
                        .y(function (d) { return d.y; })
                        .interpolate("linear");
                    run(lineFunction(lineData[0]), 0);
                    run(lineFunction(lineData[1]), 10);
                    run(lineFunction(lineData[2]), 20);
                    run(lineFunction(lineData[3]), 30);
                    run(lineFunction(lineData[4]), 40);
                    run(lineFunction(lineData[5]), 50);
                    drawTable();
                    console.log(lineData[0]);
                    console.log(lineData[1]);
                    console.log(lineData[2]);
                    console.log(lineData[3]);
                    console.log(lineData[4]);
                    console.log(lineData[5]);

                };
                reader.readAsText(file);
                document.getElementById('file').style.visibility = 'hidden';
                removeDummy();

            };



        })

        function run(ecgData, startSec) {
            //The SVG Container
            var svgContainer = d3.select("body").append("svg")
                .attr("id", "mySvg")
                .attr("style", "padding-left: 5px")
                .attr("width", ecgGridWidth)
                .attr("height", ecgGridHeight);
            svgContainer.append("defs");

            // smallGrid
            svgContainer.append("pattern")
                .attr("id", "smallGrid")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", unit)
                .attr("height", unit)

                .append("path")
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 0.5)
                .attr("d", "M " + unit + " 0 L 0 0 0 " + unit);

            // Grid
            var grid = svgContainer.append("pattern")
                .attr("id", "grid")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", unit * gridXBlocks)
                .attr("height", unit * gridYBlocks);

            grid.append("rect")
                .attr("fill", "url(#smallGrid)")
                .attr("width", unit * gridXBlocks)
                .attr("height", unit * gridYBlocks);

            grid.append("path")
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 1.5)
                .attr("d", "M " + unit * gridXBlocks + " 0 L 0 0 0 " + unit * gridYBlocks);

            // largeGrid
            var largeGrid = svgContainer.append("pattern")
                .attr("id", "largeGrid")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", unit * gridXBlocks * largeGridXBlocks)
                .attr("height", unit * gridYBlocks * largeGridYBlocks);

            largeGrid.append("rect")
                .attr("fill", "url(#grid)")
                .attr("width", unit * gridXBlocks * largeGridXBlocks)
                .attr("height", unit * gridYBlocks * largeGridYBlocks);

            largeGrid.append("path")
                .attr("fill", "none")
                .attr("stroke", "red")
                .attr("stroke-width", 3)
                .attr("d", "M " + unit * gridXBlocks * largeGridXBlocks + " 0 L 0 0 0 " + unit * gridXBlocks * largeGridYBlocks);

            svgContainer.append("rect")
                .attr("fill", "url(#largeGrid)")
                .attr("height", "100%")
                .attr("width", "100%");

            // Draw text
            var svgText = d3.select("body").append("svg")
                .attr("width", horizontalBlocks * unit * smallGridBlocks * gridXBlocks + offsetPixel + textWidth)
                // (unit * gridYBlocks) 是 0.2s 小格 一格的高度
                .attr("height", (unit * gridYBlocks));

            for (idx = 0; idx <= 10; idx++) {
                svgText.append("text")
                    .attr("x", 0 + (idx * (unit * gridXBlocks * largeGridXBlocks)))
                    .attr("y", textHeight)
                    .attr("fill", "black")
                    .text(startSec + idx);
            }

            svgContainer.append("path")
                .attr("d", ecgData)
                .attr("stroke", "black").attr("stroke-width", 1.3)
                .attr("fill", "none");


        }

        // All is hardcode
        function drawTable() {
            var titleWidth = ecgGridWidth / 12;
            var titleHeight = 50;
            var titleStrY = 28;

            // 顯示的的文字
            var titleStrs = ["Mean heart rate", "Unit:bpm", "PR interval", "Unit:sec.", "QRS duration", "Unit:sec.", "QT interval", "Unit:sec.", "QTc interval", "Unit:sec.", "ST level", "Unit:mm."];
            // 文字距離左邊多少距離
            var titleTextPaddingLeft = [5, 10, 15, 15, 10, 15, 10, 15, 10, 15, 15, 15];
            // 每個格子的寬度，如果第 n 個寬度加 5 pixel，表示寬度增加 5 pixel，但是 n+1 的 x 位置要加上 5 ，這個加上 5 的動作在 titleXOffset 中設定。
            var titleRectWidthOffset = [titleWidth + 13, titleWidth - 13, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth, titleWidth];
            // 位移格子
            var titleXOffset = [0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            var svgTitleTable = d3.select("body").append("svg")
                .attr("style", "padding-left: 5px")
                .attr("width", ecgGridWidth)
                .attr("height", titleHeight);

            for (i = 0; i < 12; i++) {
                var g = svgTitleTable.append("g");
                var temp = g.append("rect")
                    .attr("x", 0 + (i * titleWidth) + titleXOffset[i])
                    .attr("y", 0)
                    .attr("width", titleRectWidthOffset[i])
                    .attr("height", titleHeight)
                    .attr("fill", "none")
                    .attr("stroke-width", 2)
                    .attr("stroke", "black");
                g.append("text")
                    .attr("x", titleTextPaddingLeft[i] + (i * titleWidth) + titleXOffset[i])
                    .attr("y", titleStrY)
                    .attr("font-size", 10)
                    .attr("fill", "black")
                    .text(titleStrs[i]);
            }

            var valueStrs = [0, 0, 0, 0, 0, 0];
            var valueWidth = ecgGridWidth / 6;
            var valueHeight = 50;
            var valueStrY = 28;
            var valueTextPaddingLeft = (valueWidth / 2) - 5;

            var svgValueTable = d3.select("body").append("svg")
                .attr("style", "padding-left: 5px")
                .attr("width", ecgGridWidth)
                .attr("height", valueHeight);
            svgValueTable.append("defs");

            // smallGrid
            svgValueTable.append("pattern")
                .attr("id", "valueGrid")
                .attr("patternUnits", "userSpaceOnUse")
                .attr("width", valueWidth)
                .attr("height", valueHeight)

                .append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("width", valueWidth)
                .attr("height", valueHeight)
                .attr("fill", "none")
                .attr("stroke-width", 2)
                .attr("stroke", "black");

            svgValueTable.append("rect")
                .attr("fill", "url(#valueGrid)")
                .attr("stroke-width", 2)
                .attr("stroke", "black")
                .attr("height", "100%")
                .attr("width", "100%");

            for (i = 0; i < 6; i++) {
                svgValueTable.append("text")
                    .attr("x", (i * valueWidth) + valueTextPaddingLeft)
                    .attr("y", valueStrY)
                    .attr("font-size", 10)
                    .attr("fill", "black")
                    .text(valueStrs[i]);
            }
        }

        function removeDummy() {
            var elem = document.getElementById('file');
            elem.parentNode.removeChild(elem);
            return false;
        }
    </script>
</body>

</html>